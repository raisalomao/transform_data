{% load static %}
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transformando e Limpando</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/transform_page.css' %}" />
    <link rel="icon" href="{% static 'img/icon.png' %}" />
</head>
<body>
    <div class="container-fluid p-4 animate-slide-in">
        <div class="row">
            <div class="col-12 col-lg-3 mb-4">
                <div class="control-panel mb-4">
                    <h4>Transformando e Limpando</h4>
                    <hr />
                    <div class="mb-3">
                        <label for="operation-select" class="form-label fw-bold">1. Escolha uma operação:</label>
                        <select class="form-select" id="operation-select" aria-label="Selecione uma operação">
                            <option selected disabled>Selecione...</option>
                            <optgroup label="Limpeza e Estrutura">
                                <option value="drop_null_rows">Remover Linhas em Branco</option>
                                <option value="drop_duplicates">Remover Linhas Duplicadas</option>
                                <option value="remove_rows_by_value">Remover Linhas por Valor</option>
                                <option value="drop_column">Remover Coluna</option>
                                <option value="filter_rows_by_value">Filtrar Linhas por Valor</option>
                                <option value="sort_column">Ordenar Coluna(s)</option>
                            </optgroup>
                            <optgroup label="Formatação e Tipo">
                                <option value="change_case">Mudar Case do Texto</option>
                                <option value="change_column_type">Mudar Tipo da Coluna</option>
                                <option value="rename_column">Renomear Coluna</option>
                                <option value="replace_values">Substituir Valores</option>
                                <option value="trim_spaces">Cortar (Remover Espaços)</option>
                                <option value="add_prefix">Adicionar Prefixo</option>
                                <option value="add_suffix">Adicionar Sufixo</option>
                            </optgroup>
                            <optgroup label="Criação e Extração">
                                <option value="add_new_column">Adicionar Nova Coluna</option>
                                <option value="split_by_delimiter">Separar Coluna por Delimitador</option>
                                <option value="merge_columns">Mesclar Colunas</option>
                                <option value="duplicate_column">Duplicar Coluna</option>
                                <option value="extract_from_date">Extrair de Data (Ano/Mês/Dia)</option>
                                <option value="conditional_column">Coluna Condicional</option>
                                <option value="split_date_time">Separar Data e Hora</option>
                            </optgroup>
                            <optgroup label="Agregação">
                                <option value="group_by">Agrupar por</option>
                            </optgroup>
                        </select>
                    </div>
                    <div id="params-container" class="mb-3" aria-live="polite" aria-atomic="true"></div>
                    <div class="d-grid">
                        <button class="btn btn-secondary" id="add-step-btn" disabled>2. Adicionar à lista</button>
                    </div>
                </div>

                <div class="d-flex flex-column" style="max-height: 100vh; overflow-y: auto;">
                    <div class="d-flex flex-column flex-grow-1 gap-3 mb-3">
                        <div class="card flex-fill">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Etapas aplicadas</h5>
                                
                                <button class="btn btn-outline-danger btn-sm" 
                                        id="clear-all-steps-btn"
                                        data-bs-toggle="popover"
                                        data-bs-placement="left"
                                        data-bs-title="Confirmar Exclusão"
                                        data-bs-html="true" 
                                        type="button"
                                        disabled>
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <div class="card-body" id="recipe-list" aria-live="polite" aria-atomic="true">
                                <p class="text-muted">Nenhum passo adicionado ainda.</p>
                            </div>
                        </div>

                        <div class="card flex-fill">
                            <div class="card-header">
                                <h5>Lista de macros</h5>
                            </div>
                            <div class="card-body" id="macro-list-container" aria-live="polite" aria-atomic="true">
                                <p class="text-muted">Nenhuma macro salva ainda.</p>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100" id="save-macro-btn-modal-trigger" type="button">
                        <i class="fas fa-save me-2"></i>Salvar tratamento atual
                    </button>
                </div>
            </div>

            <div class="col-12 col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span id="table-title">Listando sua tabela de dados</span>
                        <div class="d-flex align-items-center gap-3">
                            <input type="search" id="data-search-input" class="form-control form-control-sm" placeholder="Pesquisar..." style="width: 250px;" aria-label="Pesquisar na tabela" />
                            
                            <div class="spinner-border text-primary" role="status" id="loading-spinner" style="display: none;">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            
                            <label for="row-limit-select" class="form-label mb-0 small">Escolha quantas linhas mostrar:</label>
                            <select class="form-select form-select-sm w-auto" id="row-limit-select">
                                <option value="10">10</option>
                                <option value="100" selected>100</option>
                                <option value="1000">1000</option>
                                <option value="-1">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body table-responsive" id="data-table-container">
                        </div>
                </div>

                <div class="mt-3 d-flex flex-column flex-md-row justify-content-between gap-2 align-items-center"> <div class="d-flex align-items-center gap-3">
                        <a href="{% url 'extracting_page' %}" class="btn btn-secondary" aria-label="Voltar para Extração">
                            Voltar para Extração
                        </a>
                        
                        <span id="file-info-display" class="small"></span>
                    </div>
                    <div>
                        <button class="btn btn-success me-2" id="apply-all-btn" type="button" aria-label="Aplicar e Visualizar">
                            <i class="fas fa-sync-alt me-2"></i>Aplicar e Visualizar
                        </button>
                        <button id="btn-avancar-loading" class="btn btn-primary" type="button" aria-label="Avançar para Carregamento">
                            Avançar para Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="saveMacroModal" tabindex="-1" aria-labelledby="saveMacroModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveMacroModalLabel">Salvar Tratamento (Macro)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="save-macro-form">
                        <div class="mb-3">
                            <label for="macro-name" class="form-label">Nome da Macro</label>
                            <input type="text" class="form-control" id="macro-name" required autocomplete="off" />
                            <div class="form-text">Dê um nome curto e descritivo</div>
                        </div>
                        <div class="mb-3">
                            <label for="macro-description" class="form-label">Descrição (Opcional)</label>
                            <textarea class="form-control" id="macro-description" rows="3" autocomplete="off"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-macro-confirm-btn">Salvar Macro</button>
                </div>
            </div>
        </div>
    </div>
    <script id="colunas-json-data" type="application/json">
        {{ colunas_json|safe }}
    </script>
    <script id="linhas-json-data" type="application/json">
        {{ linhas_json|safe }}
    </script>
    <script id="total-rows-data" type="application/json">
        {{ total_row_count }}
    </script> 
    <script id="original-filename-data" type="application/json">
        {{ original_filename_json|safe }}
    </script>

    <script>
        const applyTransformUrl = "{% url 'apply_transform' %}";
        const loadingPageUrl = "{% url 'loading_page' %}";
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="{% static 'js/tooltip.js' %}"></script>
    <script type="module" src="{% static 'js/transform_page.js' %}"></script>
</body>
</html>